# 時系列予測プログラム - 週次・四半期予測

## 概要

このプログラムは、健診数などの日次データに対してSARIMAXモデルを使用した時系列予測を行います。祝日を外部変数として考慮し、ウォークフォワード検証による精度評価と、未来の週次（7日間）・四半期（90日間）の予測を実行します。

## 主な機能

1. **データの読み込みと前処理**: CSVファイルから日次データを読み込み、欠損値を補完
2. **祝日データの統合**: jpholidayライブラリを使用して日本の祝日を外部変数として追加
3. **ウォークフォワード検証**: 1ヶ月ごとに訓練データを拡張しながら予測精度を評価
4. **予測精度評価**: MAE、RMSE、MAPEを使用した評価指標の算出
5. **未来予測**: 週次（7日間）および四半期（90日間）の予測値を生成
6. **可視化**: 実績値と予測値を比較するグラフの表示

## 必要なライブラリ

```python
pandas
numpy
matplotlib
statsmodels
scikit-learn
python-dateutil
jpholiday
```

インストール:
```bash
pip install pandas numpy matplotlib statsmodels scikit-learn python-dateutil jpholiday
```

## 設定パラメータ

以下のパラメータをスクリプト上部で編集できます（14-19行目）:

| パラメータ | 説明 | デフォルト値 |
|-----------|------|-------------|
| `CSV_FILE_PATH` | 読み込むCSVファイルのパス | `'hidden_training1.csv'` |
| `DATE_COLUMN` | 日付列の列名 | `'年月'` |
| `VALUE_COLUMN` | 予測対象の値の列名 | `'当日の健診数'` |
| `FUTURE_FORECAST_DAYS_WEEKLY` | 週次予測の日数 | `7` |
| `FUTURE_FORECAST_DAYS_QUARTERLY` | 四半期予測の日数 | `90` |

## データフォーマット

CSVファイルは以下の形式である必要があります:

```csv
年月,当日の健診数
2023-01-01,120
2023-01-02,135
2023-01-03,0
...
```

- 日付形式: `YYYY-MM-DD`
- 数値: 整数または小数
- 欠損値: 自動的に0で補完されます

## モデルパラメータ

### SARIMAXモデルの設定（52-55行目）

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| `initial_train_size` | 1096 | 初期訓練データのサイズ（約3年分） |
| `test_period_months` | 1 | テスト期間（1ヶ月） |
| `sarima_order` | (1, 1, 1) | SARIMA (p, d, q) パラメータ |
| `seasonal_order` | (1, 1, 0, 7) | 季節性 (P, D, Q, s) パラメータ（7日周期） |

## プログラムの流れ

### 1. データの読み込みと前処理
- CSVファイルを読み込み、日付をインデックスに設定
- 欠損値を0で補完
- 日次頻度（'D'）でデータを整形

### 2. 祝日データの作成とマージ
- `jpholiday`ライブラリを使用して日本の祝日を取得
- `is_holiday`列を作成（祝日: 1, 平日: 0）

### 3. ウォークフォワード検証
- 初期訓練データ（1096日）から開始
- 1ヶ月ごとにテスト期間を設定し、予測を実行
- 訓練データを徐々に拡張しながら繰り返し
- 各期間のMAE、RMSE、MAPEを計算

### 4. 評価結果の表示
- 1ヶ月ごとの予測誤差をテーブル形式で出力

### 5. ウォークフォワード結果の可視化
- 実績値と予測値を重ねたグラフを表示
- テスト期間を青色の背景で表示

### 6. 最終モデルの学習
- 全データを使用してSARIMAXモデルを学習
- 祝日を外部変数として含める

### 7. 未来7日間の予測（週次）
- 最終日の翌日から7日間の予測を生成
- 過去90日間の実績と比較するグラフを表示
- 予測期間を緑色の背景で表示

### 8. 未来90日間の予測（四半期）
- 最終日の翌日から90日間の予測を生成
- 過去180日間の実績と比較するグラフを表示
- 予測期間をオレンジ色の背景で表示

## 出力例

### 評価結果テーブル

```
                          期間    MAE      RMSE      MAPE
0  2023-04-01 ～ 2023-04-30   12.45    15.32    0.089
1  2023-05-01 ～ 2023-05-31   10.89    13.21    0.076
2  2023-06-01 ～ 2023-06-30   14.32    18.45    0.102
...
```

### 週次予測結果

```
2024-01-01    145
2024-01-02    152
2024-01-03    148
...
```

## グラフ出力

プログラムは以下の3つのグラフを生成します:

1. **ウォークフォワード検証結果**: 実績値と予測値の比較
2. **週次予測**: 過去90日間の実績と未来7日間の予測
3. **四半期予測**: 過去180日間の実績と未来90日間の予測

## 評価指標

| 指標 | 説明 |
|-----|------|
| **MAE** (Mean Absolute Error) | 平均絶対誤差 - 予測値と実績値の差の絶対値の平均 |
| **RMSE** (Root Mean Squared Error) | 二乗平均平方根誤差 - 大きな誤差により敏感 |
| **MAPE** (Mean Absolute Percentage Error) | 平均絶対パーセント誤差 - 誤差を割合で表現 |

## カスタマイズ方法

### 予測期間の変更

```python
FUTURE_FORECAST_DAYS_WEEKLY = 14      # 2週間に変更
FUTURE_FORECAST_DAYS_QUARTERLY = 180  # 半年に変更
```

### モデルパラメータの調整

```python
sarima_order = (2, 1, 2)          # より複雑なモデル
seasonal_order = (1, 1, 1, 7)     # 季節性の移動平均項を追加
```

### 日本語フォントの設定

Matplotlibで日本語を表示する場合、22行目のコメントを解除:

```python
plt.rcParams['font.family'] = 'IPAexGothic'
```

## 注意事項

- データは日次で連続している必要があります
- 初期訓練データサイズ（1096日）以上のデータが必要です
- 祝日データは自動的に取得されますが、インターネット接続は不要です
- 計算に時間がかかる場合があります（データ量に依存）
- 予測値は整数に丸められます

## トラブルシューティング

### ファイルが見つからない

```
エラー: ファイル 'hidden_training1.csv' が見つかりません。
```
→ `CSV_FILE_PATH`を正しいパスに変更してください

### 日本語が文字化けする

→ 22行目のフォント設定のコメントを解除し、適切な日本語フォントを指定してください

### データが不足している

```
データ期間: 2023-01-01 から 2023-12-31 まで
```
→ 最低でも1096日（約3年）以上のデータが必要です

## ファイル情報

- **ファイル名**: [new_project_weekly_and_quarterly_forecast.py](new_project_weekly_and_quarterly_forecast.py)
- **作成日**: 2025年
- **Python バージョン**: Python 3.7以上推奨
- **行数**: 169行
